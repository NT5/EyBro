<template>
  <div id="app">
    <!-- Your main view, should have "view-main" class -->
    <div class="view view-main view-init safe-areas" data-url="/"></div>

    <!-- Datos del usuario -->
    <div class="login-screen" id="login-datos-visitante">
      <div class="view">
        <div class="page">
          <div class="page-content login-screen-content">
            <div class="login-screen-title">CuÃ©ntame sobre ti ðŸ¤”</div>
            <div class="list">
              <ul>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Â¿Quieres decirme tu nombre o al menos un sobrenombre con el cual
                      suelen llamarte?</div>
                    <div class="item-input-wrap">
                      <input type="text" name="usuario" placeholder="Â¿Como te llamas?" value="${usuario}"
                        @input="${updateUsuario}" autocomplete="off" />
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Â¿Quieres decirme en que centro estudias?</div>
                    <div class="item-input-wrap">
                      <input type="text" name="centro_estudio" placeholder="Â¿A que escuela vas?"
                        value="${centro_estudio}" @input="${updateCentroEstudio}" autocomplete="off" />
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Â¿Quieres decirme en que municipio y departamento se ubica tu
                      centro educativo?</div>
                    <div class="item-input-wrap">
                      <input type="text" name="departamento" placeholder="Â¿De donde eres?" value="${departamento}"
                        @input="${updateDepartamento}" autocomplete="off" />
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Â¿Quieres decirme que grado cursas actualmente?</div>
                    <div class="item-input-wrap">
                      <input type="text" name="grado_cursado" placeholder="Â¿En que grado vas?" value="${grado_cursado}"
                        @input="${updateGradoCursado}" autocomplete="off" />
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Â¿Y como se llama tu maestro o maestra tutor?</div>
                    <div class="item-input-wrap">
                      <input type="text" name="tutor" placeholder="Â¿Tu maestro?" value="${tutor}"
                        @input="${updateTutor}" autocomplete="off" />
                    </div>
                  </div>
                </li>
                <li class="item-content item-input">
                  <div class="item-inner">
                    <div class="item-title item-label">Â¿Quieres decirme que edad tienes?</div>
                    <div class="item-input-wrap">
                      <input type="text" name="edad" placeholder="Â¿Cuantos aÃ±os tienes?" value="${edad}"
                        @input="${updateEdad}" autocomplete="off" />
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div class="list">
              <ul>
                <li>
                  <a href="#"
                    class="item-link list-button login-button button button-large button-fill text-color-white"
                    @click="${registrarVisitante}">
                    <i class="icon material-icons">beenhere</i>
                    Comenzar!
                  </a>
                </li>
              </ul>
              <div class="block-footer">
                Â¡Ey! Bro â€¦ Solo Entre vos y Yoâ€¦
                <br />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</template>
<style>
  :root {
    --f7-login-screen-blocks-max-width: 580px;
  }
</style>
<script>
  export default (props, { $f7, $update, $on, $store }) => {
    // Plugin de configuraciÃ³n
    const config = $f7.config;

    // Datos del usuario
    let usuario = 'AnÃ³nimo';
    let centro_estudio = 'AnÃ³nimo';
    let departamento = 'AnÃ³nimo';
    let grado_cursado = 'AnÃ³nimo';
    let tutor = 'AnÃ³nimo';
    let edad = 'AnÃ³nimo';

    // MÃ©todos para actualizar las variables locales de la pagina de registro
    const updateUsuario = (e) => {
      usuario = e.target.value;
      $update();
    }
    const updateCentroEstudio = (e) => {
      centro_estudio = e.target.value;
      $update();
    }
    const updateDepartamento = (e) => {
      departamento = e.target.value;
      $update();
    }
    const updateGradoCursado = (e) => {
      grado_cursado = e.target.value;
      $update();
    }
    const updateTutor = (e) => {
      tutor = e.target.value;
      $update();
    }
    const updateEdad = (e) => {
      edad = e.target.value;
      $update();
    }

    // Registra al visitante
    const registrarVisitante = () => {
      let api_url = config.api_url;

      // API Endpoint
      let request_url = `${api_url}/visitante/registreVisitante`;

      $f7.request({
        url: request_url,
        method: 'POST',
        contentType: 'application/x-www-form-urlencoded',
        dataType: 'json',
        data: {
          uuid: new DeviceUUID().get(), // LibrerÃ­a uuid
          identificador: JSON.stringify({ // Se crea un objeto y se convierte a string para enviarlo al servidor
            usuario: usuario,
            centro_estudio: centro_estudio,
            departamento: departamento,
            grado_cursado: grado_cursado,
            tutor: tutor,
            edad: edad,
          })
        }
      }).then((response) => {
        // Los datos se ingresaron correctamente
        let data = response.data;

        // Se decompila el string identificador para guardarse en store
        let meta = JSON.parse(data.visitante.identificador);

        let visitante = data.visitante;
        visitante.identificador = meta;

        // Se despacha la variable visitante en la aplicaciÃ³n
        $store.dispatch('setVisitante', visitante);

        $f7.dialog.alert(`Gracias! ya podemos comenzar con las preguntas`, () => {
          $f7.loginScreen.close();
        });

        console.log(`[+] Se registro el visitante en el sistema ID: ${visitante.id_visitante} | ${visitante.uuid}`, visitante);

      }).catch((err) => {
        // No se pudo conectar con el servidor ???
        console.error(err);
        $f7.dialog.alert(`Lo siento no se pudo crear un usuario, intentalo de nuevo mas tarde`, () => {
          $f7.loginScreen.close();
        });
      });
    }

    return $render;
  }
</script>